name: Hermes Client Build

on:
  workflow_dispatch:

jobs:
  build-armbian:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fetch Armbian Build
        run: |
          git clone --depth=1 --branch=main https://github.com/armbian/build
          cd build
          git fetch origin 60e869c42c03af0428d9983750eb766a7a846d43
          git checkout 60e869c42c03af0428d9983750eb766a7a846d43

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          sudo apt-get install -y \
            device-tree-compiler \
            qemu-user-static \
            binfmt-support \
            qemu-system-arm \
            qemu-efi-aarch64 \
            qemu-utils \
            gcc-aarch64-linux-gnu \
            u-boot-tools \
            libssl-dev \
            patch \
            flex \
            bison
          sudo update-binfmts --enable
          sudo systemctl restart systemd-binfmt

      - name: Setup QEMU for cross compilation
        run: |
          sudo apt-get install -y qemu-user-static
          which qemu-aarch64-static || echo "QEMU aarch64 not found"
          sudo cp /usr/bin/qemu-aarch64-static /usr/local/bin/
          
      - name: Setup userpatches structure
        run: |
          mkdir -p build/userpatches/config/boards
          mkdir -p build/userpatches/overlay
          mkdir -p build/userpatches/patch/u-boot/v2025.04/board_sakurapi-rk3308b/
          
          if [ -d "userpatches" ]; then
            cp -r userpatches/* build/userpatches/
          fi
          
          # 修复：EOF 闭合 + 配置格式修正
          cat > build/userpatches/config/boards/sogou_e1.conf << 'EOL'
          BOARD_NAME="Sogou E1"
          BOARDFAMILY="rockchip64"
          BOOTCONFIG="sakurapi_rk3308b_defconfig"
          BOOTBRANCH="tag:v2025.04"
          BOOTPATCHDIR="v2025.04"
          KERNEL_TARGET="current"
          BOOT_FDT_FILE="rockchip/rk3308-sogou-e1.dtb"
          SERIALCON="ttyS2:1500000"
          HAS_VIDEO_OUTPUT="no"
          BL31_BLOB="rk33/rk3308_bl31_v2.26.elf"
          DDR_BLOB="rk33/rk3308_ddr_589MHz_uart2_m1_v1.30.bin"
          MINILOADER_BLOB="rk33/rk3308_miniloader_sd_nand_v1.13.bin"
          PACKAGE_LIST_BOARD="alsa-utils firmware-realtek firmware-brcm80211 wireless-regdb wpasupplicant hostapd iw"
          EOL

      - name: Setup device tree
        run: |
          if [ -f userpatches/extracted.dts ]; then
            echo "发现自定义设备树文件，正在处理..."
            mkdir -p build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip
            cp userpatches/extracted.dts build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dts
            dtc -I dts -O dtb -o build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dtb build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dts
            echo "自定义设备树已编译为DTB"
          else
            echo "未找到自定义DTS文件，使用RK3308默认配置"
            mkdir -p build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip
            curl -o build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dts \
              https://github.com/rockchip-linux/kernel/raw/master/arch/arm64/boot/dts/rockchip/rk3308-evb.dts
          fi

      - name: Pre-build U-Boot (修复克隆+EOF语法)
        run: |
          cd build
          mkdir -p cache/sources/u-boot/v2025.04
          # 修复：直接克隆U-Boot main分支，切换到v2025.04 tag（避免轻量标签问题）
          git clone --depth=1 https://github.com/u-boot/u-boot.git cache/sources/u-boot/v2025.04
          cd cache/sources/u-boot/v2025.04
          git checkout tags/v2025.04 -b v2025.04  # 切换到标签并创建分支
          cd ../../../../
          # 应用补丁
          patch -d cache/sources/u-boot/v2025.04 -p1 < userpatches/patch/u-boot/v2025.04/board_sakurapi-rk3308b/add-board-sakurapi-rk3308b.patch
          # 验证defconfig
          if [ -f cache/sources/u-boot/v2025.04/configs/sakurapi_rk3308b_defconfig ]; then
            echo "✅ sakurapi_rk3308b_defconfig 生成成功！"
          else
            echo "❌ defconfig生成失败，手动创建"
            # 修复：EOF 正确闭合 + 单行配置（避免换行问题）
            cat > cache/sources/u-boot/v2025.04/configs/sakurapi_rk3308b_defconfig << EOF
            CONFIG_ARM64=y
            CONFIG_ARCH_ROCKCHIP=y
            CONFIG_TARGET_SAKURAPI_RK3308B=y
            CONFIG_SYS_MALLOC_F_LEN=0x2000
            CONFIG_ROCKCHIP_GPIO=y
            CONFIG_SYS_LOAD_ADDR=0x80800000
            CONFIG_SERIAL_CONSOLE=y
            CONFIG_CONSOLE_BAUDRATE=1500000
            CONFIG_SYS_MMC_ENV_DEV=0
            CONFIG_ROCKCHIP_SDMMC=y
            EOF
            # 验证EOF闭合
            if [ -f cache/sources/u-boot/v2025.04/configs/sakurapi_rk3308b_defconfig ]; then
              echo "✅ 手动创建defconfig成功"
            fi
          fi

      - name: Build Armbian image
        run: |
          cd build
          # 修复：编译命令单行书写（避免换行符导致的语法错误）
          sudo ./compile.sh BOARD=sogou_e1 BRANCH=current RELEASE=bookworm BUILD_MINIMAL=yes BUILD_DESKTOP=no KERNEL_CONFIGURE=no COMPRESS_OUTPUTIMAGE=sha,img BOOTCONFIG=sakurapi_rk3308b_defconfig BOOTBRANCH=tag:v2025.04 SKIP_UBOOT_DOWNLOAD=yes ARCH=arm64 TARGET=image IMAGE_SIZE=4G -j$(nproc)

      - name: Upload image
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3308-e1
          path: |
            build/output/images/*.img
            build/output/images/*.img.sha
            build/output/logs/*.log
