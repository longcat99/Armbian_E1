name: Hermes Client Build

on:
  workflow_dispatch:

jobs:
  build-armbian:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fetch Armbian Build
        run: |
          git clone --depth=1 https://github.com/armbian/build
          cd build
          # 检出稳定版（避免最新代码的兼容性问题）
          git checkout 23.02.2

      - name: Install dependencies
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y \
            device-tree-compiler qemu-user-static binfmt-support \
            qemu-system-arm qemu-efi-aarch64 qemu-utils \
            gcc-aarch64-linux-gnu u-boot-tools libssl-dev patch flex bison
          sudo update-binfmts --enable
          sudo systemctl restart systemd-binfmt

      - name: Setup QEMU
        run: |
          sudo apt install -y qemu-user-static
          sudo cp /usr/bin/qemu-aarch64-static /usr/local/bin/
          which qemu-aarch64-static && echo "QEMU ready" || echo "QEMU missing"

      - name: Setup userpatches
        run: |
          # 1. 创建目录结构
          mkdir -p build/userpatches/{config/boards,kernel/rockchip64-current/arch/arm64/boot/dts/rockchip}
          
          # 2. 写入板型配置（核心：EOF 单独一行，无空格/注释干扰）
          cat > build/userpatches/config/boards/sogou_e1.conf << 'EOL'
          BOARD_NAME="Sogou E1"
          BOARDFAMILY="rockchip64"
          BOOTCONFIG="rk3308_defconfig"
          BOOTBRANCH="tag:v2022.07"
          KERNEL_TARGET="current"
          BOOT_FDT_FILE="rockchip/rk3308-sogou-e1.dtb"
          SERIALCON="ttyS2:1500000"
          HAS_VIDEO_OUTPUT="no"
          BL31_BLOB="rk33/rk3308_bl31_v2.26.elf"
          DDR_BLOB="rk33/rk3308_ddr_589MHz_uart2_m1_v1.30.bin"
          MINILOADER_BLOB="rk33/rk3308_miniloader_sd_nand_v1.13.bin"
          PACKAGE_LIST_BOARD="alsa-utils firmware-realtek firmware-brcm80211 wireless-regdb wpasupplicant hostapd iw"
          EOL

          # 3. 写入设备树（兜底）
          cat > build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dts << 'EOL'
          /dts-v1/;
          #include "rk3308.dtsi"
          / {
            model = "Sogou E1";
            compatible = "rockchip,rk3308-sogou-e1", "rockchip,rk3308";
            chosen {
              stdout-path = "serial2:1500000n8";
            };
          };
          &uart2 {
            status = "okay";
          };
          &sdmmc {
            status = "okay";
            bus-width = <4>;
          };
          EOL

          # 4. 预编译设备树
          dtc -I dts -O dtb -o build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dtb build/userpatches/kernel/rockchip64-current/arch/arm64/boot/dts/rockchip/rk3308-sogou-e1.dts

      - name: Build Armbian image (关键：让Armbian自动处理U-Boot)
        run: |
          cd build
          # 核心：不手动干预U-Boot，让Armbian自动下载适配的版本
          sudo ./compile.sh \
            BOARD=sogou_e1 \
            BRANCH=current \
            RELEASE=bookworm \
            BUILD_MINIMAL=yes \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE=sha,img \
            ARCH=arm64 \
            TARGET=image \
            IMAGE_SIZE=4G \
            -j$(nproc)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3308-e1
          path: |
            build/output/images/*.img
            build/output/images/*.img.sha
            build/output/logs/*.log
